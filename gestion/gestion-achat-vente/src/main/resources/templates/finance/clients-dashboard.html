<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/main :: layout(~{::content})}">
<body>
    <div th:fragment="content">
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-2xl font-bold text-slate-800">Analyse des Ventes & Performance</h1>
                <p class="text-slate-500 text-sm">Données consolidées en temps réel.</p>
            </div>
            <div class="flex items-center gap-3">
                <form method="get" class="bg-white shadow-sm border border-slate-200 px-3 py-2 rounded-xl flex items-center gap-2">
                    <label for="months" class="text-[10px] font-bold text-slate-500 uppercase">Période</label>
                    <select id="months" name="months" class="text-xs font-bold text-slate-700" onchange="this.form.submit()">
                        <option value="3" th:selected="${monthsBack == 3}">3 mois</option>
                        <option value="6" th:selected="${monthsBack == 6}">6 mois</option>
                        <option value="12" th:selected="${monthsBack == 12}">12 mois</option>
                        <option value="24" th:selected="${monthsBack == 24}">24 mois</option>
                    </select>
                </form>
                <div class="bg-white shadow-sm border border-slate-200 px-4 py-2 rounded-xl flex items-center gap-3">
                    <span class="flex h-2 w-2 rounded-full bg-emerald-500"></span>
                    <span class="text-xs font-bold text-slate-600 uppercase tracking-widest" 
                          th:text="${#temporals.format(#temporals.createNow(), 'MMMM yyyy')}">Février 2026</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Chiffre d'Affaires HT</p>
                <h3 class="text-2xl font-black text-slate-800 mt-1" th:text="${#numbers.formatCurrency(caTotal)}">0 Ar</h3>
                <p class="text-[10px] text-slate-400 mt-2 italic">Basé sur les lignes de facture</p>
            </div>

            <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Marge Brute</p>
                <h3 class="text-2xl font-black text-emerald-600 mt-1" th:text="${#numbers.formatCurrency(margeTotale)}">0 Ar</h3>
                <p class="text-[10px] text-emerald-500 font-bold mt-2">Taux : <span th:text="${tauxMarge}">0</span>%</p>
            </div>

            <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Encaissé TTC</p>
                <h3 class="text-2xl font-black text-blue-600 mt-1" th:text="${#numbers.formatCurrency(totalEncaisse != null ? totalEncaisse : 0)}">0 Ar</h3>
                <div class="w-full bg-slate-100 h-1.5 rounded-full mt-3">
                    <div class="bg-blue-500 h-1.5 rounded-full transition-all duration-1000" 
                         th:style="'width:' + ${tauxRecouvrement > 100 ? 100 : (tauxRecouvrement < 0 ? 0 : tauxRecouvrement)} + '%'" ></div>
                </div>
            </div>

            <div class="bg-rose-50 p-5 rounded-2xl border border-rose-100 shadow-sm">
                <p class="text-[10px] font-black text-rose-400 uppercase tracking-widest">Reste à percevoir</p>
                <h3 class="text-2xl font-black text-rose-700 mt-1" th:text="${#numbers.formatCurrency(resteARecouvrer)}">0 Ar</h3>
                <p class="text-[10px] text-rose-500 font-bold mt-2" th:text="${100 - tauxRecouvrement + '% du facturé'}">0%</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                <div class="mb-6">
                    <h4 class="font-bold text-slate-800">Performance Mensuelle</h4>
                    <p class="text-xs text-slate-400">CA vs Marge Brute HT</p>
                </div>
                <div class="h-[300px]">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                <div class="mb-6">
                    <h4 class="font-bold text-slate-800">Santé de la Trésorerie</h4>
                    <p class="text-xs text-slate-400">Ratio Encaissé / Créances (TTC)</p>
                </div>
                <div class="flex flex-col md:flex-row items-center justify-around h-[300px]">
                    <div class="w-48 h-48">
                        <canvas id="paymentPieChart"></canvas>
                    </div>
                    <div class="space-y-4">
                        <div class="flex items-center gap-3">
                            <span class="w-3 h-3 rounded-full bg-blue-500"></span>
                            <div>
                                <p class="text-[10px] font-bold text-slate-400 uppercase">Perçu</p>
                                <p class="font-bold text-slate-700" th:text="${#numbers.formatCurrency(totalEncaisse)}">0 Ar</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="w-3 h-3 rounded-full bg-rose-500"></span>
                            <div>
                                <p class="text-[10px] font-bold text-slate-400 uppercase">Attendu</p>
                                <p class="font-bold text-slate-700" th:text="${#numbers.formatCurrency(resteARecouvrer)}">0 Ar</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script th:inline="javascript">
            /* Données injectées depuis le contrôleur */
            const labels = /*[[${chartLabels}]]*/ ['Jan', 'Fév'];
            const dataCA = /*[[${chartDataCA}]]*/ [0, 0];
            const dataMarge = /*[[${chartDataMarge}]]*/ [0, 0];
            const totalEncaisse = /*[[${totalEncaisse != null ? totalEncaisse : 0}]]*/ 0;
            const resteARecouvrer = /*[[${resteARecouvrer != null ? resteARecouvrer : 0}]]*/ 0;

            // Configuration Graphique Barres
            new Chart(document.getElementById('salesChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'CA HT',
                            data: dataCA,
                            backgroundColor: '#6366f1',
                            borderRadius: 8,
                            barThickness: 40
                        },
                        {
                            label: 'Marge HT',
                            data: dataMarge,
                            backgroundColor: '#10b981',
                            borderRadius: 8,
                            barThickness: 40
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { display: false } },
                        x: { grid: { display: false } }
                    },
                    plugins: {
                        legend: { position: 'top', align: 'end', labels: { usePointStyle: true, boxWidth: 6 } }
                    }
                }
            });

            // Configuration Graphique Doughnut
            new Chart(document.getElementById('paymentPieChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Encaissé', 'Créances'],
                    datasets: [{
                        data: [totalEncaisse, resteARecouvrer],
                        backgroundColor: ['#3b82f6', '#f43f5e'],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    cutout: '80%',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        </script>
    </div>
</body>
</html>