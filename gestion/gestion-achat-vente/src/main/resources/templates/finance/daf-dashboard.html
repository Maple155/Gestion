<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/main :: layout(~{::content})}">
<body>
    <div th:fragment="content">
        <div class="flex justify-between items-end mb-8">
            <div>
                <h1 class="text-2xl font-bold text-slate-800">Direction Financière</h1>
                <p class="text-slate-500" th:text="${'Analyse du ' + #temporals.format(dateJour, 'dd MMMM yyyy')}"></p>
            </div>
            <div th:if="${mismatchCount > 0}" class="bg-rose-100 text-rose-700 px-4 py-2 rounded-full text-xs font-bold animate-pulse">
                ⚠ <span th:text="${mismatchCount}">0</span> ANOMALIES DÉTECTÉES
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-slate-900 p-5 rounded-xl text-white">
                <p class="text-[10px] uppercase text-slate-400 font-bold">Chiffre d'Affaires</p>
                <h4 class="text-2xl font-black mt-1" th:text="${#numbers.formatCurrency(caTotal)}">0</h4>
            </div>
            <div class="bg-white p-5 rounded-xl border border-slate-200">
                <p class="text-[10px] uppercase text-slate-400 font-bold">Marge Brute (<span th:text="${tauxMarge}">0</span>%)</p>
                <h4 class="text-2xl font-black text-emerald-600 mt-1" th:text="${#numbers.formatCurrency(margeTotale)}">0</h4>
            </div>
            <div class="bg-white p-5 rounded-xl border border-slate-200">
                <p class="text-[10px] uppercase text-slate-400 font-bold">Écart Valeur Stock</p>
                <h4 class="text-2xl font-black mt-1" th:classappend="${ecartStock != 0 ? 'text-rose-500' : 'text-slate-800'}" 
                    th:text="${#numbers.formatCurrency(ecartStock)}">0</h4>
            </div>
            <div class="bg-white p-5 rounded-xl border border-slate-200">
                <p class="text-[10px] uppercase text-slate-400 font-bold">Val. Opérationnelle</p>
                <h4 class="text-2xl font-black text-blue-600 mt-1" th:text="${#numbers.formatCurrency(valeurOperationnelle)}">0</h4>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="px-6 py-4 bg-rose-50 border-b border-rose-100">
                <h2 class="font-bold text-rose-800 flex items-center">
                    <i data-lucide="alert-triangle" class="w-4 h-4 mr-2"></i> Anomalies de Facturation (Audit)
                </h2>
            </div>
            <table class="w-full text-left border-collapse">
                <thead class="bg-slate-50 text-[10px] uppercase text-slate-500">
                    <tr>
                        <th class="px-6 py-3 font-bold">Facture</th>
                        <th class="px-6 py-3 font-bold">BC Source</th>
                        <th class="px-6 py-3 font-bold text-rose-600">Motif du litige</th>
                        <th class="px-6 py-3 font-bold">Montant TTC</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 text-sm">
                    <tr th:each="m : ${mismatches}" class="hover:bg-rose-50/30">
                        <td class="px-6 py-3 font-medium" th:text="${m.numeroFacture}">FA-000</td>
                        <td class="px-6 py-3 text-slate-500" th:text="${m.referenceBc}">BC-000</td>
                        <td class="px-6 py-3">
                            <span class="px-2 py-1 bg-rose-100 text-rose-700 rounded text-[10px] font-bold" th:text="${m.motif}">Erreur</span>
                        </td>
                        <td class="px-6 py-3 font-bold" th:text="${#numbers.formatCurrency(m.montant)}">0</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</body>
</html>