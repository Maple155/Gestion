<!-- templates/stock/lots/liste.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${title}">Gestion des Lots</title>
    
    <!-- Bootstrap 5 + Icons + DataTables -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
    
    <style>
        .lot-card {
            border-left: 4px solid;
            transition: all 0.3s;
        }
        .lot-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .lot-DISPONIBLE { border-left-color: #28a745; }
        .lot-PERIME { border-left-color: #dc3545; }
        .lot-EPUISE { border-left-color: #6c757d; }
        .lot-QUARANTAINE { border-left-color: #ffc107; }
        .lot-BLOQUE { border-left-color: #6c757d; }
        .lot-FUSIONNE { border-left-color: #17a2b8; }
        .badge-statut { font-size: 0.7rem; }
        .peremption-urgence { background-color: #dc3545; color: white; }
        .peremption-alerte { background-color: #ffc107; color: black; }
        .perimentation-normal { background-color: #28a745; color: white; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav th:replace="~{fragments/navbar :: navbar(activePage=${activePage})}"></nav>
    
    <div class="container-fluid mt-4">
        <!-- En-tête -->
        <div class="row mb-4">
            <div class="col">
                <h1>
                    <i class="bi bi-tag"></i> Gestion des Lots
                    <small class="text-muted" th:text="'(' + ${totalElements} + ')'">(245)</small>
                </h1>
                <p class="text-muted">Traçabilité complète des lots et gestion des péremptions</p>
            </div>
            <div class="col-auto">
                <a href="/stock/lots/nouveau" class="btn btn-success">
                    <i class="bi bi-plus-circle"></i> Nouveau Lot
                </a>
                <a href="/stock/lots/alertes-peremption" class="btn btn-warning">
                    <i class="bi bi-exclamation-triangle"></i> Alertes
                </a>
            </div>
        </div>
        
        <!-- Statistiques -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="card">
                    <div class="card-body text-center p-2">
                        <h5 th:text="${stats.totalLots}">245</h5>
                        <small class="text-muted">Lots total</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card">
                    <div class="card-body text-center p-2">
                        <h5 class="text-success" th:text="${stats.lotsDisponibles}">180</h5>
                        <small class="text-muted">Disponibles</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card">
                    <div class="card-body text-center p-2">
                        <h5 class="text-warning" th:text="${stats.lotsProchePeremption}">15</h5>
                        <small class="text-muted">Péremption < 30j</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card">
                    <div class="card-body text-center p-2">
                        <h5 class="text-danger" th:text="${stats.lotsPerimes}">8</h5>
                        <small class="text-muted">Périmés</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card">
                    <div class="card-body text-center p-2">
                        <h5 class="text-secondary" th:text="${stats.lotsEpulses}">42</h5>
                        <small class="text-muted">Épuisés</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card">
                    <div class="card-body text-center p-2">
                        <h5 th:text="${#numbers.formatCurrency(stats.valeurRisque)}">12.500 €</h5>
                        <small class="text-muted">Valeur à risque</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Filtres -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-funnel"></i> Filtres de recherche</h5>
            </div>
            <div class="card-body">
                <form method="get" action="/stock/lots/liste" class="row g-3">
                    <!-- Numéro de lot -->
                    <div class="col-md-2">
                        <input type="text" name="numeroLot" class="form-control" 
                               placeholder="Numéro lot..."
                               th:value="${numeroLot}">
                    </div>
                    
                    <!-- Article -->
                    <div class="col-md-2">
                        <input type="text" name="articleId" class="form-control" 
                               placeholder="Code article..."
                               th:value="${articleId}">
                    </div>
                    
                    <!-- Statut -->
                    <div class="col-md-2">
                        <select name="statut" class="form-select">
                            <option value="">Tous statuts</option>
                            <option value="DISPONIBLE" th:selected="${statut == 'DISPONIBLE'}">Disponible</option>
                            <option value="PERIME" th:selected="${statut == 'PERIME'}">Périmé</option>
                            <option value="EPUISE" th:selected="${statut == 'EPUISE'}">Épuisé</option>
                            <option value="QUARANTAINE" th:selected="${statut == 'QUARANTAINE'}">Quarantaine</option>
                            <option value="BLOQUE" th:selected="${statut == 'BLOQUE'}">Bloqué</option>
                        </select>
                    </div>
                    
                    <!-- Dépôt -->
                    <div class="col-md-2">
                        <input type="text" name="depotId" class="form-control" 
                               placeholder="Dépôt..."
                               th:value="${depotId}">
                    </div>
                    
                    <!-- Péremption proche -->
                    <div class="col-md-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" 
                                   name="prochePeremption" value="true" 
                                   th:checked="${prochePeremption}">
                            <label class="form-check-label">
                                Péremption < 30 jours
                            </label>
                        </div>
                    </div>
                    
                    <!-- Boutons -->
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search"></i> Rechercher
                        </button>
                        <a href="/stock/lots/liste" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle"></i> Réinitialiser
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Tableau des lots -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-table"></i> Liste des Lots
                    <span class="badge bg-secondary" th:text="${totalElements}">245</span>
                </h5>
                
                <!-- Actions batch -->
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-danger" onclick="bloquerLotsSelectionnes()">
                        <i class="bi bi-slash-circle"></i> Bloquer
                    </button>
                    <a href="/stock/lots/export" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-download"></i> Exporter
                    </a>
                </div>
            </div>
            
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAll"></th>
                                <th>Numéro Lot</th>
                                <th>Article</th>
                                <th>Quantité</th>
                                <th>Dates</th>
                                <th>Péremption</th>
                                <th>Coût</th>
                                <th>Statut</th>
                                <th>Dépôt</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="lot : ${lots}" 
                                th:class="'lot-' + ${lot.statut}">
                                <td>
                                    <input type="checkbox" class="lot-checkbox" 
                                           th:value="${lot.id}">
                                </td>
                                <td>
                                    <strong>
                                        <a th:href="@{'/stock/lots/details/' + ${lot.id}}"
                                           th:text="${lot.numeroLot}">
                                            LOT-2024-001
                                        </a>
                                    </strong>
                                    <br>
                                    <small class="text-muted" 
                                           th:if="${lot.bonReceptionRef}"
                                           th:text="'BR: ' + ${lot.bonReceptionRef}">
                                        BR-2024-001
                                    </small>
                                </td>
                                <td>
                                    <a th:href="@{'/stock/articles/details/' + ${lot.articleId}}">
                                        <span th:text="${lot.articleCode}">ART-001</span>
                                    </a>
                                    <br>
                                    <small class="text-muted" 
                                           th:text="${lot.articleLibelle}">
                                        Yaourt Nature
                                    </small>
                                </td>
                                <td>
                                    <div th:if="${lot.quantiteActuelle == 0}" 
                                         class="text-danger">
                                        <i class="bi bi-x-circle"></i> Épuisé
                                    </div>
                                    <div th:if="${lot.quantiteActuelle > 0}">
                                        <span th:text="${lot.quantiteActuelle}">150</span> /
                                        <span th:text="${lot.quantiteInitiale}">200</span>
                                        <div class="progress" style="height: 5px;">
                                            <div class="progress-bar" 
                                                 th:style="'width: ' + ${lot.quantiteActuelle / lot.quantiteInitiale * 100} + '%;'"
                                                 th:class="${lot.quantiteActuelle / lot.quantiteInitiale < 0.2} ? 'bg-warning' : 'bg-success'">
                                            </div>
                                        </div>
                                        <small class="text-muted">
                                            Reste: <span th:text="${lot.quantiteActuelle}">150</span>
                                        </small>
                                    </div>
                                </td>
                                <td>
                                    <small>
                                        Réception: 
                                        <span th:text="${#temporals.format(lot.dateReception, 'dd/MM/yy')}">
                                            01/03/24
                                        </span>
                                        <br>
                                        <span th:if="${lot.dateFabrication}">
                                            Fabrication: 
                                            <span th:text="${#temporals.format(lot.dateFabrication, 'dd/MM/yy')}">
                                                28/02/24
                                            </span>
                                        </span>
                                    </small>
                                </td>
                                <td>
                                    <div th:if="${lot.datePeremption}">
                                        <span th:text="${#temporals.format(lot.datePeremption, 'dd/MM/yyyy')}">
                                            01/04/2024
                                        </span>
                                        <br>
                                        <span th:class="${lot.joursRestants < 0} ? 'badge peremption-urgence' : 
                                                         ${lot.joursRestants < 7} ? 'badge peremption-alerte' : 
                                                         'badge perimentation-normal'}"
                                              th:text="${lot.joursRestants} + ' jours'">
                                            25 jours
                                        </span>
                                        <span th:if="${lot.dluo}" class="ms-1">
                                            <br>
                                            <small class="text-muted">
                                                DLUO: 
                                                <span th:text="${#temporals.format(lot.dluo, 'dd/MM/yy')}">
                                                    15/04/24
                                                </span>
                                            </small>
                                        </span>
                                    </div>
                                    <div th:if="${!lot.datePeremption}">
                                        <span class="badge bg-secondary">Non périssable</span>
                                    </div>
                                </td>
                                <td>
                                    <span th:text="${#numbers.formatCurrency(lot.coutUnitaire)}">
                                        1.15 €
                                    </span>
                                    <br>
                                    <small class="text-muted" 
                                           th:text="'Val: ' + ${#numbers.formatCurrency(lot.valeur)}">
                                        Val: 172.50 €
                                    </small>
                                </td>
                                <td>
                                    <span th:class="'badge badge-statut lot-' + ${lot.statut}"
                                          th:text="${lot.statut}">
                                        DISPONIBLE
                                    </span>
                                </td>
                                <td>
                                    <span th:text="${lot.depotNom}">Entrepôt Central</span>
                                    <br>
                                    <small class="text-muted" th:if="${lot.emplacementCode}"
                                           th:text="${lot.emplacementCode}">
                                        A01-05-02
                                    </small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a th:href="@{'/stock/lots/details/' + ${lot.id}}"
                                           class="btn btn-outline-primary" title="Détails">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <button class="btn btn-outline-danger" 
                                                th:if="${lot.statut == 'DISPONIBLE'}"
                                                onclick="changerStatutLot('[[${lot.id}]]', 'PERIME')"
                                                title="Marquer périmé">
                                            <i class="bi bi-calendar-x"></i>
                                        </button>
                                        <button class="btn btn-outline-warning" 
                                                th:if="${lot.statut == 'DISPONIBLE'}"
                                                onclick="changerStatutLot('[[${lot.id}]]', 'QUARANTAINE')"
                                                title="Mettre en quarantaine">
                                            <i class="bi bi-shield-exclamation"></i>
                                        </button>
                                        <a th:href="@{'/stock/mouvements/sortie?lotId=' + ${lot.id}}"
                                           class="btn btn-outline-success"
                                           th:if="${lot.statut == 'DISPONIBLE' && lot.quantiteActuelle > 0}"
                                           title="Sortie stock">
                                            <i class="bi bi-box-arrow-up"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <nav th:if="${totalPages > 1}">
                    <ul class="pagination justify-content-center">
                        <li class="page-item" th:classappend="${page == 0} ? 'disabled' : ''">
                            <a class="page-link" th:href="@{/stock/lots/liste(page=0, size=${size})}">
                                <i class="bi bi-chevron-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item" th:classappend="${page == 0} ? 'disabled' : ''">
                            <a class="page-link" th:href="@{/stock/lots/liste(page=${page-1}, size=${size})}">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                        <li th:each="i : ${#numbers.sequence(0, totalPages-1)}"
                            class="page-item" 
                            th:classappend="${i == page} ? 'active' : ''">
                            <a class="page-link" th:href="@{/stock/lots/liste(page=${i}, size=${size})}"
                               th:text="${i+1}">1</a>
                        </li>
                        <li class="page-item" th:classappend="${page == totalPages-1} ? 'disabled' : ''">
                            <a class="page-link" th:href="@{/stock/lots/liste(page=${page+1}, size=${size})}">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                        <li class="page-item" th:classappend="${page == totalPages-1} ? 'disabled' : ''">
                            <a class="page-link" th:href="@{/stock/lots/liste(page=${totalPages-1}, size=${size})}">
                                <i class="bi bi-chevron-double-right"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
        
        <!-- Actions batch -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-gear"></i> Actions sur Lots Sélectionnés</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <select id="batchAction" class="form-select">
                            <option value="">-- Choisir une action --</option>
                            <option value="PERIME">Marquer comme périmé</option>
                            <option value="QUARANTAINE">Mettre en quarantaine</option>
                            <option value="BLOQUE">Bloquer</option>
                            <option value="DISPONIBLE">Rendre disponible</option>
                            <option value="EXPORT">Exporter</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <input type="text" id="batchMotif" class="form-control" 
                               placeholder="Motif (optionnel)">
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary w-100" onclick="appliquerActionBatch()">
                            <i class="bi bi-check-circle"></i> Appliquer
                        </button>
                    </div>
                </div>
                
                <!-- Fusion de lots -->
                <div class="row mt-4">
                    <div class="col-12">
                        <h6><i class="bi bi-arrow-left-right"></i> Fusion de Lots</h6>
                        <div class="input-group">
                            <input type="text" id="lotSource" class="form-control" 
                                   placeholder="Lot source (ID ou numéro)">
                            <span class="input-group-text">→</span>
                            <input type="text" id="lotDestination" class="form-control" 
                                   placeholder="Lot destination (ID ou numéro)">
                            <button class="btn btn-info" onclick="fusionnerLots()">
                                <i class="bi bi-arrow-left-right"></i> Fusionner
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    
    <script>
        // Sélection/déselection tous
        document.getElementById('selectAll').addEventListener('change', function(e) {
            const checkboxes = document.querySelectorAll('.lot-checkbox');
            checkboxes.forEach(cb => cb.checked = e.target.checked);
        });
        
        // Changer statut d'un lot
        function changerStatutLot(lotId, nouveauStatut) {
            const motif = prompt('Motif du changement (optionnel):');
            
            fetch('/stock/lots/changer-statut/' + lotId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'nouveauStatut': nouveauStatut,
                    'motif': motif || ''
                })
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Erreur lors du changement de statut');
                }
            });
        }
        
        // Actions batch
        function appliquerActionBatch() {
            const action = document.getElementById('batchAction').value;
            const motif = document.getElementById('batchMotif').value;
            const selectedLots = Array.from(document.querySelectorAll('.lot-checkbox:checked'))
                .map(cb => cb.value);
            
            if (selectedLots.length === 0) {
                alert('Veuillez sélectionner au moins un lot');
                return;
            }
            
            if (!action) {
                alert('Veuillez choisir une action');
                return;
            }
            
            if (confirm(`Appliquer l'action "${action}" sur ${selectedLots.length} lot(s) ?`)) {
                // Implémenter l'appel API batch
                alert('Fonctionnalité batch en cours de développement');
            }
        }
        
        // Fusionner lots
        function fusionnerLots() {
            const lotSource = document.getElementById('lotSource').value;
            const lotDestination = document.getElementById('lotDestination').value;
            
            if (!lotSource || !lotDestination) {
                alert('Veuillez spécifier les deux lots');
                return;
            }
            
            if (confirm('Fusionner les lots ? Cette action est irréversible.')) {
                fetch('/stock/lots/fusionner', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'lotSourceId': lotSource,
                        'lotDestinationId': lotDestination,
                        'motif': 'Fusion manuelle'
                    })
                })
                .then(response => {
                    if (response.ok) {
                        alert('Lots fusionnés avec succès');
                        location.reload();
                    } else {
                        alert('Erreur lors de la fusion');
                    }
                });
            }
        }
        
        // Initialiser DataTables
        $(document).ready(function() {
            $('table').DataTable({
                pageLength: 20,
                lengthMenu: [[10, 20, 50, 100], [10, 20, 50, 100]],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/fr-FR.json'
                }
            });
            
            // Mettre en évidence les lots proches péremption
            $('tr.lot-PERIME').css('background-color', 'rgba(220, 53, 69, 0.1)');
            $('.badge.peremption-alerte, .badge.peremption-urgence').parent().parent()
                .css('background-color', 'rgba(255, 193, 7, 0.1)');
        });
    </script>
</body>
</html>