<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
>
  <head>
    <title>Nouveau Lot</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-slate-50">
    <div class="flex h-screen">
      <div th:replace="~{fragments/sidebar_stock}"></div>

      <!-- Main Content -->
      <div class="flex-1 overflow-auto"> 
    <div>
      <!-- En-tête -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
              <li class="breadcrumb-item">
                <a th:href="@{/lots}">Lots</a>
              </li>
              <li class="breadcrumb-item active" aria-current="page">
                Nouveau lot
              </li>
            </ol>
          </nav>
          <h1 class="h3 mb-0">
            <i class="bi bi-plus-circle text-success"></i>
            Créer un nouveau lot
          </h1>
        </div>
      </div>

      <!-- Messages flash -->
      <div
        th:if="${errorMessage}"
        class="alert alert-danger alert-dismissible fade show"
        role="alert"
      >
        <i class="bi bi-exclamation-circle"></i>
        <span th:text="${errorMessage}"></span>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
        ></button>
      </div>

      <!-- Formulaire -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-pencil-square"></i> Informations du lot
          </h5>
        </div>
        <div class="card-body">
          <form
            th:action="@{/lots/nouveau}"
            method="post"
            th:object="${lotDTO}"
          >
            <div class="row">
              <!-- Numéro de lot -->
              <div class="col-md-6 mb-3">
                <label class="form-label"
                  >Numéro de lot <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  th:field="*{numeroLot}"
                  required
                  placeholder="LOT-2024-001"
                  th:classappend="${#fields.hasErrors('numeroLot')} ? 'is-invalid'"
                />
                <div
                  class="invalid-feedback"
                  th:if="${#fields.hasErrors('numeroLot')}"
                  th:errors="*{numeroLot}"
                ></div>
                <small class="text-muted"
                  >Format recommandé: LOT-YYYY-NNN</small
                >
              </div>

              <!-- Article -->
              <div class="col-md-6 mb-3">
                <label class="form-label"
                  >Article <span class="text-danger">*</span></label
                >
                <select
                  class="form-select"
                  th:field="*{articleId}"
                  required
                  th:classappend="${#fields.hasErrors('articleId')} ? 'is-invalid'"
                  onchange="loadArticleInfo(this.value)"
                >
                  <option value="">Sélectionnez un article</option>
                  <option
                    th:each="article : ${articles}"
                    th:value="${article.id}"
                    th:text="${article.codeArticle + ' - ' + article.libelle}"
                  ></option>
                </select>
                <div
                  class="invalid-feedback"
                  th:if="${#fields.hasErrors('articleId')}"
                  th:errors="*{articleId}"
                ></div>

                <!-- Info article -->
                <div id="articleInfo" class="mt-2 d-none">
                  <small>
                    <span id="articleGestionLot" class="badge bg-info"></span>
                    <span id="articleUnite" class="text-muted ms-2"></span>
                  </small>
                </div>
              </div>
            </div>

            <div class="row">
              <!-- Bon de réception -->
              <div class="col-md-6 mb-3">
                <label class="form-label">Bon de réception</label>
                <select class="form-select" th:field="*{bonReceptionId}">
                  <option value="">Non lié à un bon de réception</option>
                  <option
                    th:each="bon : ${bonsReception}"
                    th:value="${bon.id}"
                    th:text="${bon.observations + ' - ' + #temporals.format(bon.dateReception, 'dd/MM/yyyy')}"
                  ></option>
                </select>
              </div>

              <!-- Emplacement -->
              <div class="col-md-6 mb-3">
                <label class="form-label">Emplacement</label>
                <select class="form-select" th:field="*{emplacementId}">
                  <option value="">Non assigné</option>
                  <option
                    th:each="emplacement : ${emplacements}"
                    th:value="${emplacement.id}"
                    th:text="${emplacement.code + ' - ' + emplacement.zone.depot.nom}"
                  ></option>
                </select>
              </div>
            </div>

            <div class="row">
              <!-- Quantités -->
              <div class="col-md-4 mb-3">
                <label class="form-label"
                  >Quantité initiale <span class="text-danger">*</span></label
                >
                <input
                  type="number"
                  class="form-control"
                  th:field="*{quantiteInitiale}"
                  min="1"
                  step="1"
                  required
                  th:classappend="${#fields.hasErrors('quantiteInitiale')} ? 'is-invalid'"
                />
                <div
                  class="invalid-feedback"
                  th:if="${#fields.hasErrors('quantiteInitiale')}"
                  th:errors="*{quantiteInitiale}"
                ></div>
              </div>

              <div class="col-md-4 mb-3">
                <label class="form-label"
                  >Quantité actuelle <span class="text-danger">*</span></label
                >
                <input
                  type="number"
                  class="form-control"
                  th:field="*{quantiteActuelle}"
                  min="0"
                  step="1"
                  required
                  th:classappend="${#fields.hasErrors('quantiteActuelle')} ? 'is-invalid'"
                />
                <div
                  class="invalid-feedback"
                  th:if="${#fields.hasErrors('quantiteActuelle')}"
                  th:errors="*{quantiteActuelle}"
                ></div>
              </div>

              <div class="col-md-4 mb-3">
                <label class="form-label"
                  >Coût unitaire (€) <span class="text-danger">*</span></label
                >
                <input
                  type="number"
                  class="form-control"
                  th:field="*{coutUnitaire}"
                  min="0"
                  step="0.0001"
                  required
                  th:classappend="${#fields.hasErrors('coutUnitaire')} ? 'is-invalid'"
                />
                <div
                  class="invalid-feedback"
                  th:if="${#fields.hasErrors('coutUnitaire')}"
                  th:errors="*{coutUnitaire}"
                ></div>
              </div>
            </div>

            <div class="row">
              <!-- Dates -->
              <div class="col-md-4 mb-3">
                <label class="form-label">Date de fabrication</label>
                <input
                  type="date"
                  class="form-control"
                  th:field="*{dateFabrication}"
                  th:max="${#temporals.format(today, 'yyyy-MM-dd')}"
                />
              </div>

              <div class="col-md-4 mb-3">
                <label class="form-label"
                  >Date de réception <span class="text-danger">*</span></label
                >
                <input
                  type="date"
                  class="form-control"
                  th:field="*{dateReception}"
                  th:value="${#temporals.format(today, 'yyyy-MM-dd')}"
                  required
                  th:max="${#temporals.format(today, 'yyyy-MM-dd')}"
                />
              </div>

              <div class="col-md-4 mb-3">
                <label class="form-label">Date de péremption</label>
                <input
                  type="date"
                  class="form-control"
                  th:field="*{datePeremption}"
                  th:min="${#temporals.format(today, 'yyyy-MM-dd')}"
                />
              </div>
            </div>

            <!-- Durée de vie (calcul automatique) -->
            <div class="row mb-3 d-none" id="dureeVieSection">
              <div class="col-md-6">
                <div class="alert alert-info">
                  <i class="bi bi-info-circle"></i>
                  Durée de vie de l'article:
                  <span id="dureeVieJours"></span> jours
                  <br />
                  <small
                    >Date de péremption calculée automatiquement si la date de
                    fabrication est renseignée.</small
                  >
                </div>
              </div>
            </div>

            <!-- Certificat de conformité -->
            <div class="mb-3">
              <label class="form-label">Certificat de conformité (URL)</label>
              <input
                type="url"
                class="form-control"
                th:field="*{certificatConformite}"
                placeholder="https://..."
              />
            </div>

            <!-- Boutons -->
            <div class="d-flex justify-content-between">
              <button
                type="button"
                class="btn btn-outline-secondary"
                onclick="window.history.back()"
              >
                <i class="bi bi-x-circle"></i> Annuler
              </button>
              <button type="submit" class="btn btn-success">
                <i class="bi bi-check-circle"></i> Créer le lot
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Charger les informations de l'article
      function loadArticleInfo(articleId) {
        if (!articleId) {
          document.getElementById("articleInfo").classList.add("d-none");
          document.getElementById("dureeVieSection").classList.add("d-none");
          return;
        }

        axios
          .get(`/api/articles/${articleId}`)
          .then((response) => {
            const article = response.data;
            const articleInfo = document.getElementById("articleInfo");
            const dureeVieSection = document.getElementById("dureeVieSection");

            // Afficher les informations de base
            document.getElementById("articleGestionLot").textContent =
              article.gestionParLot ? "Géré par lot" : "Non géré par lot";
            document.getElementById("articleUnite").textContent =
              article.uniteMesure ? article.uniteMesure.libelle : "";

            articleInfo.classList.remove("d-none");

            // Gérer la durée de vie
            if (article.dureeVieJours) {
              document.getElementById("dureeVieJours").textContent =
                article.dureeVieJours;
              dureeVieSection.classList.remove("d-none");
            } else {
              dureeVieSection.classList.add("d-none");
            }

            // Calculer automatiquement la date de péremption si date de fabrication est remplie
            const dateFabricationInput = document.querySelector(
              'input[name="dateFabrication"]'
            );
            const datePeremptionInput = document.querySelector(
              'input[name="datePeremption"]'
            );

            dateFabricationInput.addEventListener("change", function () {
              if (this.value && article.dureeVieJours) {
                const dateFabrication = new Date(this.value);
                const datePeremption = new Date(dateFabrication);
                datePeremption.setDate(
                  datePeremption.getDate() + article.dureeVieJours
                );

                const formattedDate = datePeremption
                  .toISOString()
                  .split("T")[0];
                datePeremptionInput.value = formattedDate;
              }
            });
          })
          .catch((error) => {
            console.error(
              "Erreur lors du chargement des informations de l'article:",
              error
            );
          });
      }

      // Générer automatiquement le numéro de lot
      document.addEventListener("DOMContentLoaded", function () {
        const numeroLotInput = document.querySelector(
          'input[name="numeroLot"]'
        );
        if (!numeroLotInput.value) {
          const today = new Date();
          const year = today.getFullYear();
          numeroLotInput.value = `LOT-${year}-001`;
        }
      });
    </script>
  </body>
</html>
