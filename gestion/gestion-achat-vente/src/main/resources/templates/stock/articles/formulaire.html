<!-- templates/stock/articles/formulaire.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8">
    <title th:text="${title}">Formulaire Article</title>
    
    <!-- Bootstrap 5 + Icons + Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    
    <style>
        .form-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #0d6efd;
        }
        .form-section h5 {
            color: #0d6efd;
            margin-bottom: 20px;
            font-weight: 600;
        }
        .required-field label::after {
            content: " *";
            color: #dc3545;
            font-weight: bold;
        }
        .input-group-text {
            background-color: #e9ecef;
        }
        .status-badge {
            font-size: 0.9rem;
            padding: 8px 15px;
        }
        .form-check-input:checked {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .card-header {
            background-color: #fff;
            border-bottom: 2px solid #0d6efd;
        }
        .info-tooltip {
            color: #6c757d;
            cursor: help;
            margin-left: 5px;
        }
        .info-tooltip:hover {
            color: #0d6efd;
        }
        .alert-validation {
            display: none;
            margin-top: 10px;
        }
        .tab-pane {
            padding: 20px 0;
        }
    </style>
</head>
<body class="bg-slate-50">
    <div class="flex h-screen">
        <!-- Sidebar (à adapter selon votre structure) -->
        <div th:replace="~{fragments/sidebar_stock}"></div>

        <!-- Main Content -->
        <div class="flex-1 overflow-auto">
            <div class="container-fluid mt-4">
                
                <!-- En-tête -->
                <div class="row mb-4">
                    <div class="col">
                        <h1>
                            <i class="bi" th:class="${article != null ? 'bi-pencil-square' : 'bi-plus-circle'}"></i>
                            <span th:text="${title}">Nouvel Article</span>
                        </h1>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item">
                                    <a href="/stock/articles/liste">Articles</a>
                                </li>
                                <li class="breadcrumb-item active" th:text="${article != null ? 'Modification' : 'Nouveau'}">
                                    Nouveau
                                </li>
                            </ol>
                        </nav>
                    </div>
                </div>

                <!-- Messages d'alerte -->
                <div th:if="${param.success}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle-fill"></i>
                    <span th:text="${param.success}">Opération réussie</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                
                <div th:if="${param.error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <span th:text="${param.error}">Erreur</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <!-- Formulaire principal -->
                <form id="articleForm" method="post" action="/stock/articles/sauvegarder" class="needs-validation" novalidate>
                    <!-- ID article (caché si modification) -->
                    <input type="hidden" name="id" th:value="${article != null ? article.id : ''}">
                    
                    <!-- Navigation par onglets -->
                    <ul class="nav nav-tabs" id="articleTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="info-tab" data-bs-toggle="tab" 
                                    data-bs-target="#info" type="button" role="tab">
                                <i class="bi bi-info-circle"></i> Informations générales
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="stock-tab" data-bs-toggle="tab" 
                                    data-bs-target="#stock" type="button" role="tab">
                                <i class="bi bi-box"></i> Gestion stock
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="valorisation-tab" data-bs-toggle="tab" 
                                    data-bs-target="#valorisation" type="button" role="tab">
                                <i class="bi bi-graph-up"></i> Valorisation
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="caracteristiques-tab" data-bs-toggle="tab" 
                                    data-bs-target="#caracteristiques" type="button" role="tab">
                                <i class="bi bi-rulers"></i> Caractéristiques
                            </button>
                        </li>
                        <li class="nav-item" role="presentation" th:if="${article != null}">
                            <button class="nav-link" id="audit-tab" data-bs-toggle="tab" 
                                    data-bs-target="#audit" type="button" role="tab">
                                <i class="bi bi-clock-history"></i> Audit
                            </button>
                        </li>
                    </ul>

                    <!-- Contenu des onglets -->
                    <div class="tab-content border border-top-0 p-4 bg-white rounded-bottom" id="articleTabsContent">
                        
                        <!-- Onglet 1: Informations générales -->
                        <div class="tab-pane fade show active" id="info" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3 required-field">
                                        <label for="codeArticle" class="form-label">Code article</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-upc-scan"></i></span>
                                            <input type="text" class="form-control" id="codeArticle" 
                                                   name="codeArticle" 
                                                   th:value="${article != null ? article.codeArticle : ''}"
                                                   maxlength="100" required
                                                   pattern="[A-Za-z0-9\-_]+"
                                                   title="Caractères alphanumériques, tirets et underscores uniquement">
                                        </div>
                                        <div class="invalid-feedback">
                                            Le code article est requis (alphanumérique, tirets et underscores)
                                        </div>
                                        <small class="text-muted">Identifiant unique de l'article</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="codeBarre" class="form-label">Code barre (EAN/UPC)</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-upc-scan"></i></span>
                                            <input type="text" class="form-control" id="codeBarre" 
                                                   name="codeBarre" 
                                                   th:value="${article != null ? article.codeBarre : ''}"
                                                   maxlength="100">
                                        </div>
                                        <small class="text-muted">Code barre unique (optionnel)</small>
                                    </div>
                                    
                                    <div class="mb-3 required-field">
                                        <label for="libelle" class="form-label">Libellé</label>
                                        <input type="text" class="form-control" id="libelle" 
                                               name="libelle" 
                                               th:value="${article != null ? article.libelle : ''}"
                                               maxlength="255" required>
                                        <div class="invalid-feedback">
                                            Le libellé est requis
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="description" class="form-label">Description</label>
                                        <textarea class="form-control" id="description" 
                                                  name="description" rows="3"
                                                  th:text="${article != null ? article.description : ''}"></textarea>
                                        <small class="text-muted">Description détaillée de l'article</small>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3 required-field">
                                        <label for="categorieId" class="form-label">Catégorie</label>
                                        <select class="form-select select2" id="categorieId" name="categorieId" required>
                                            <option value="">Sélectionner une catégorie</option>
                                            <option th:each="cat : ${categories}" 
                                                    th:value="${cat.id}"
                                                    th:text="${cat.libelle}"
                                                    th:selected="${article != null and article.categorie != null and article.categorie.id == cat.id}">
                                            </option>
                                        </select>
                                        <div class="invalid-feedback">
                                            La catégorie est requise
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3 required-field">
                                        <label for="uniteMesureId" class="form-label">Unité de mesure</label>
                                        <select class="form-select select2" id="uniteMesureId" name="uniteMesureId" required>
                                            <option value="">Sélectionner une unité</option>
                                            <option th:each="unite : ${unites}" 
                                                    th:value="${unite.id}"
                                                    th:text="${unite.libelle + ' (' + unite.code + ')'}"
                                                    th:selected="${article != null and article.uniteMesure != null and article.uniteMesure.id == unite.id}">
                                            </option>
                                        </select>
                                        <div class="invalid-feedback">
                                            L'unité de mesure est requise
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label d-block">Options de gestion</label>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" 
                                                   id="gestionParLot" name="gestionParLot" value="true"
                                                   th:checked="${article != null ? article.gestionParLot : false}">
                                            <label class="form-check-label" for="gestionParLot">
                                                Gestion par lot
                                                <i class="bi bi-question-circle info-tooltip" 
                                                   title="Activer pour les articles nécessitant une traçabilité par lot (produits périssables)"></i>
                                            </label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" 
                                                   id="gestionParSerie" name="gestionParSerie" value="true"
                                                   th:checked="${article != null ? article.gestionParSerie : false}">
                                            <label class="form-check-label" for="gestionParSerie">
                                                Gestion par série
                                                <i class="bi bi-question-circle info-tooltip" 
                                                   title="Pour les articles avec numéro de série unique"></i>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3" id="dureeVieContainer" 
                                         th:style="${article != null and article.gestionParLot} ? '' : 'display: none;'">
                                        <label for="dureeVieJours" class="form-label">Durée de vie (jours)</label>
                                        <input type="number" class="form-control" id="dureeVieJours" 
                                               name="dureeVieJours" min="1"
                                               th:value="${article != null ? article.dureeVieJours : ''}">
                                        <small class="text-muted">Pour le calcul automatique de la DLC/DLUO</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" 
                                                   id="actif" name="actif" value="true"
                                                   th:checked="${article != null ? article.actif : true}">
                                            <label class="form-check-label" for="actif">Article actif</label>
                                        </div>
                                        <small class="text-muted">Décocher pour désactiver l'article (non utilisable dans les mouvements)</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Onglet 2: Gestion stock -->
                        <div class="tab-pane fade" id="stock" role="tabpanel">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="stockMinimum" class="form-label">Stock minimum</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="stockMinimum" 
                                                   name="stockMinimum" min="0" step="1"
                                                   th:value="${article != null ? article.stockMinimum : 0}">
                                            <span class="input-group-text" id="uniteMin">unités</span>
                                        </div>
                                        <small class="text-muted">Seuil d'alerte de réapprovisionnement</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="stockSecurite" class="form-label">Stock de sécurité</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="stockSecurite" 
                                                   name="stockSecurite" min="0" step="1"
                                                   th:value="${article != null ? article.stockSecurite : 0}">
                                            <span class="input-group-text">unités</span>
                                        </div>
                                        <small class="text-muted">Stock tampon pour couvrir les aléas</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="stockMaximum" class="form-label">Stock maximum</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="stockMaximum" 
                                                   name="stockMaximum" min="0" step="1"
                                                   th:value="${article != null ? article.stockMaximum : ''}">
                                            <span class="input-group-text">unités</span>
                                        </div>
                                        <small class="text-muted">Capacité maximale (optionnel)</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle"></i>
                                        <strong>Rappel des règles de gestion:</strong>
                                        <ul class="mb-0 mt-2">
                                            <li>Stock minimum < stock sécurité < stock maximum (si défini)</li>
                                            <li>Le stock de sécurité doit être supérieur au stock minimum</li>
                                            <li>Le stock maximum est optionnel</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Informations stock actuelles (si modification) -->
                            <div th:if="${article != null}" class="row mt-4">
                                <div class="col-12">
                                    <h6 class="text-primary">Situation actuelle du stock</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Dépôt</th>
                                                    <th>Stock théorique</th>
                                                    <th>Réservé</th>
                                                    <th>Disponible</th>
                                                    <th>Valeur</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="stock : ${stockParDepot}">
                                                    <td th:text="${stock.depot.nom}">Entrepôt Central</td>
                                                    <td th:text="${stock.quantiteTheorique}">200</td>
                                                    <td th:text="${stock.quantiteReservee}">50</td>
                                                    <td th:text="${stock.quantiteDisponible}">150</td>
                                                    <td th:text="${#numbers.formatCurrency(stock.valeurStockCump)}">230.00 Ar</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Onglet 3: Valorisation -->
                        <div class="tab-pane fade" id="valorisation" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="methodeValorisation" class="form-label">Méthode de valorisation</label>
                                        <select class="form-select" id="methodeValorisation" name="methodeValorisation">
                                            <option th:each="methode : ${methodesValorisation}"
                                                    th:value="${methode}"
                                                    th:text="${methode}"
                                                    th:selected="${article != null ? article.methodeValorisation : 'CUMP' == methode}">
                                            </option>
                                        </select>
                                        <small class="text-muted">
                                            <i class="bi bi-question-circle"></i>
                                            FIFO: Premier entré, premier sorti | CUMP: Coût unitaire moyen pondéré | FEFO: Premier expiré, premier sorti
                                        </small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="coutStandard" class="form-label">Coût standard (HT)</label>
                                        <div class="input-group">
                                            <span class="input-group-text">Ar</span>
                                            <input type="number" class="form-control" id="coutStandard" 
                                                   name="coutStandard" min="0" step="0.0001"
                                                   th:value="${article != null and article.coutStandard != null ? article.coutStandard : ''}">
                                        </div>
                                        <small class="text-muted">Coût de référence pour les estimations</small>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="prixVenteHt" class="form-label">Prix de vente HT</label>
                                        <div class="input-group">
                                            <span class="input-group-text">Ar</span>
                                            <input type="number" class="form-control" id="prixVenteHt" 
                                                   name="prixVenteHt" min="0" step="0.01"
                                                   th:value="${article != null and article.prixVenteHt != null ? article.prixVenteHt : ''}">
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="tvaPourcentage" class="form-label">TVA (%)</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="tvaPourcentage" 
                                                   name="tvaPourcentage" min="0" max="100" step="0.1"
                                                   th:value="${article != null and article.tvaPourcentage != null ? article.tvaPourcentage : 20.00}">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3" th:if="${article != null and article.prixVenteHt != null}">
                                        <label class="form-label">Prix de vente TTC</label>
                                        <div class="input-group">
                                            <span class="input-group-text">Ar</span>
                                            <input type="text" class="form-control" disabled
                                                   th:value="${#numbers.formatCurrency(article.prixVenteHt * (1 + (article.tvaPourcentage/100)))}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="alert alert-warning" th:if="${article != null}">
                                        <i class="bi bi-exclamation-triangle"></i>
                                        <strong>Attention:</strong> La modification des paramètres de valorisation affectera les calculs de coûts futurs. 
                                        Les historiques de coûts restent inchangés.
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Onglet 4: Caractéristiques -->
                        <div class="tab-pane fade" id="caracteristiques" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary">Caractéristiques physiques</h6>
                                    <div class="mb-3">
                                        <label for="poidsKg" class="form-label">Poids (kg)</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="poidsKg" 
                                                   name="poidsKg" min="0" step="0.001"
                                                   th:value="${article != null and article.poidsKg != null ? article.poidsKg : ''}">
                                            <span class="input-group-text">kg</span>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="volumeM3" class="form-label">Volume (m³)</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="volumeM3" 
                                                   name="volumeM3" min="0" step="0.001"
                                                   th:value="${article != null and article.volumeM3 != null ? article.volumeM3 : ''}">
                                            <span class="input-group-text">m³</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <h6 class="text-primary">Fournisseurs principaux</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Fournisseur préféré</label>
                                        <select class="form-select select2" name="fournisseurPrincipalId">
                                            <option value="">Sélectionner un fournisseur</option>
                                            <option th:each="fournisseur : ${fournisseurs}"
                                                    th:value="${fournisseur.id}"
                                                    th:text="${fournisseur.nom}">
                                            </option>
                                        </select>
                                        <small class="text-muted">Fournisseur par défaut pour les commandes</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Référence fournisseur</label>
                                        <input type="text" class="form-control" name="referenceFournisseur"
                                               placeholder="Code article chez le fournisseur">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">Dimensions pour emplacement</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-3">
                                                    <label class="form-label">Longueur (cm)</label>
                                                    <input type="number" class="form-control" min="0" step="0.1">
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Largeur (cm)</label>
                                                    <input type="number" class="form-control" min="0" step="0.1">
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Hauteur (cm)</label>
                                                    <input type="number" class="form-control" min="0" step="0.1">
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Conditionnement</label>
                                                    <input type="text" class="form-control" placeholder="Ex: Carton de 12">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Onglet 5: Audit (visible seulement en modification) -->
                        <div class="tab-pane fade" id="audit" role="tabpanel" th:if="${article != null}">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">Informations de création</h6>
                                        </div>
                                        <div class="card-body">
                                            <dl class="row">
                                                <dt class="col-sm-4">Créé le</dt>
                                                <dd class="col-sm-8" 
                                                    th:text="${article.createdAt != null ? #temporals.format(article.createdAt, 'dd/MM/yyyy HH:mm:ss') : 'N/A'}">
                                                    01/01/2024 10:30:00
                                                </dd>
                                                
                                                <dt class="col-sm-4">Créé par</dt>
                                                <dd class="col-sm-8" th:text="${article.createdBy} ?: 'Système'">admin</dd>
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">Dernières modifications</h6>
                                        </div>
                                        <div class="card-body">
                                            <dl class="row">
                                                <dt class="col-sm-4">Modifié le</dt>
                                                <dd class="col-sm-8" 
                                                    th:text="${article.updatedAt != null ? #temporals.format(article.updatedAt, 'dd/MM/yyyy HH:mm:ss') : 'N/A'}">
                                                    15/03/2024 14:45:30
                                                </dd>
                                                
                                                <dt class="col-sm-4">Modifié par</dt>
                                                <dd class="col-sm-8" th:text="${article.updatedBy} ?: 'Système'">magasinier</dd>
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">Historique des modifications</h6>
                                        </div>
                                        <div class="card-body">
                                            <p class="text-muted text-center">Fonctionnalité à venir: traçabilité complète des modifications</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Boutons d'action en bas -->
                    <div class="row mt-4">
                        <div class="col-12 d-flex justify-content-between">
                            <div>
                                <button type="reset" class="btn btn-outline-warning me-2">
                                    <i class="bi bi-arrow-counterclockwise"></i> Réinitialiser
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save"></i> Enregistrer l'article
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
                
                <!-- Informations complémentaires pour les articles gérés par lot -->
                <div th:if="${article != null and article.gestionParLot}" class="card mt-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-tags"></i> Lots associés</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>N° Lot</th>
                                        <th>Quantité</th>
                                        <th>Date réception</th>
                                        <th>Date péremption</th>
                                        <th>Statut</th>
                                        <th>Dépôt</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="lot : ${lots}">
                                        <td th:text="${lot.numeroLot}">LOT-2024-001</td>
                                        <td th:text="${lot.quantiteActuelle}">150</td>
                                        <td th:text="${#temporals.format(lot.dateReception, 'dd/MM/yyyy')}">01/03/2024</td>
                                        <td th:text="${#temporals.format(lot.datePeremption, 'dd/MM/yyyy')}">01/04/2024</td>
                                        <td>
                                            <span class="badge" 
                                                  th:classappend="${lot.statut == 'DISPONIBLE'} ? 'bg-success' : 
                                                                  (lot.statut == 'PERIME' ? 'bg-danger' : 'bg-secondary')"
                                                  th:text="${lot.statut}">DISPONIBLE</span>
                                        </td>
                                        <td th:text="${lot.emplacement.zone.depot.nom}">Entrepôt Central</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="text-end">
                            <a th:href="@{'/lots/article/' + ${article.id}}" class="btn btn-sm btn-outline-info">
                                Voir tous les lots
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script th:inline="javascript">
        /*<![CDATA[*/
        $(document).ready(function() {
            // Initialisation Select2
            $('.select2').select2({
                theme: 'bootstrap-5',
                width: '100%',
                placeholder: 'Sélectionner...',
                allowClear: true
            });
            
            // Validation du formulaire
            var forms = document.querySelectorAll('.needs-validation');
            Array.prototype.slice.call(forms).forEach(function(form) {
                form.addEventListener('submit', function(event) {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                        
                        // Activer l'onglet contenant les erreurs
                        var firstInvalid = form.querySelector(':invalid');
                        if (firstInvalid) {
                            var tabId = firstInvalid.closest('.tab-pane').id;
                            if (tabId) {
                                var tabTrigger = new bootstrap.Tab(document.querySelector('#articleTabs button[data-bs-target="#' + tabId + '"]'));
                                tabTrigger.show();
                            }
                        }
                    }
                    form.classList.add('was-validated');
                }, false);
            });
            
            // Gestion de l'affichage conditionnel de la durée de vie
            $('#gestionParLot').change(function() {
                if (this.checked) {
                    $('#dureeVieContainer').slideDown();
                } else {
                    $('#dureeVieContainer').slideUp();
                    $('#dureeVieJours').val('');
                }
            });
            
            // Mise à jour automatique des unités dans les labels
            $('#uniteMesureId').change(function() {
                var selectedText = $(this).find('option:selected').text();
                var unite = selectedText.split('(')[1]?.replace(')', '') || 'unités';
                $('#uniteMin').text(unite);
            });
            
            // Calcul automatique du TTC
            $('#prixVenteHt, #tvaPourcentage').on('input', function() {
                var prixHt = parseFloat($('#prixVenteHt').val()) || 0;
                var tva = parseFloat($('#tvaPourcentage').val()) || 0;
                var prixTtc = prixHt * (1 + (tva / 100));
                
                var ttcField = $('input[disabled]').last();
                if (ttcField.length) {
                    ttcField.val(new Intl.NumberFormat('fr-FR', { 
                        style: 'currency', 
                        currency: 'MGA' 
                    }).format(prixTtc));
                }
            });
            
            // Confirmation avant réinitialisation
            $('button[type="reset"]').click(function(e) {
                if (!confirm('Êtes-vous sûr de vouloir réinitialiser tous les champs ?')) {
                    e.preventDefault();
                }
            });
            
            // Désactiver la gestion par série si gestion par lot est activée (et vice versa)
            $('#gestionParLot, #gestionParSerie').change(function() {
                if ($('#gestionParLot').is(':checked') && $('#gestionParSerie').is(':checked')) {
                    var currentId = $(this).attr('id');
                    if (currentId === 'gestionParLot') {
                        $('#gestionParSerie').prop('checked', false);
                    } else {
                        $('#gestionParLot').prop('checked', false);
                        $('#dureeVieContainer').slideUp();
                    }
                }
            });
            
            // Vérification de cohérence des seuils
            $('#stockMinimum, #stockSecurite, #stockMaximum').on('input', function() {
                var min = parseInt($('#stockMinimum').val()) || 0;
                var sec = parseInt($('#stockSecurite').val()) || 0;
                var max = parseInt($('#stockMaximum').val()) || null;
                
                if (sec < min) {
                    $('#stockSecurite').addClass('is-invalid');
                    $('#stockSecurite').next('.invalid-feedback').remove();
                    $('#stockSecurite').after('<div class="invalid-feedback">Le stock de sécurité doit être supérieur au stock minimum</div>');
                } else {
                    $('#stockSecurite').removeClass('is-invalid');
                }
                
                if (max && max <= sec) {
                    $('#stockMaximum').addClass('is-invalid');
                    $('#stockMaximum').next('.invalid-feedback').remove();
                    $('#stockMaximum').after('<div class="invalid-feedback">Le stock maximum doit être supérieur au stock de sécurité</div>');
                } else {
                    $('#stockMaximum').removeClass('is-invalid');
                }
            });
        });
        /*]]>*/
    </script>
    
    <!-- Styles additionnels pour Select2 -->
    <style>
        .select2-container--bootstrap-5 .select2-selection {
            min-height: 38px;
        }
        .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
            line-height: 36px;
        }
        .select2-container--bootstrap-5 .select2-selection--single .select2-selection__arrow {
            height: 36px;
        }
        .was-validated .select2-container--bootstrap-5 .select2-selection--single {
            border-color: #dc3545;
        }
    </style>
</body>
</html>