<!-- templates/stock/dashboard/mouvements.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Mouvements</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-slate-50">
    <div class="flex h-screen">
        <!-- Sidebar Stock -->
        <div th:replace="~{fragments/sidebar_stock}"></div>
        
        <!-- Main Content -->
        <div class="flex-1 overflow-auto">
            <!-- Top Header -->
            <header class="top-header px-8 py-4 bg-white border-b border-slate-200 sticky top-0 z-10">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                            <i data-lucide="activity" class="w-5 h-5 text-blue-600"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-slate-800">Dashboard Mouvements</h1>
                            <p class="text-sm text-slate-500">
                                Analyse des entrées et sorties sur 
                                <span th:text="${jours}" class="font-bold">7</span> jours
                            </p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="flex bg-slate-100 rounded-xl p-1">
                            <a th:href="@{/stock/dashboard/mouvements(jours=7)}" 
                               th:classappend="${jours == 7} ? 'bg-white shadow-sm text-slate-800' : 'text-slate-600'"
                               class="px-4 py-2 rounded-lg text-sm font-bold transition-all">
                                7 jours
                            </a>
                            <a th:href="@{/stock/dashboard/mouvements(jours=30)}" 
                               th:classappend="${jours == 30} ? 'bg-white shadow-sm text-slate-800' : 'text-slate-600'"
                               class="px-4 py-2 rounded-lg text-sm font-bold transition-all">
                                30 jours
                            </a>
                            <a th:href="@{/stock/dashboard/mouvements(jours=90)}" 
                               th:classappend="${jours == 90} ? 'bg-white shadow-sm text-slate-800' : 'text-slate-600'"
                               class="px-4 py-2 rounded-lg text-sm font-bold transition-all">
                                90 jours
                            </a>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content Area -->
            <main class="p-8">
                <!-- KPI Mouvements -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Entrées -->
                    <div class="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <div class="text-xs font-bold text-slate-500 uppercase tracking-wider">Entrées</div>
                                <div class="text-3xl font-bold text-emerald-600" 
                                     th:text="${stats.totalEntrees}">0</div>
                            </div>
                            <i class="bi bi-box-arrow-in-down text-emerald-200 text-3xl"></i>
                        </div>
                        <div class="text-sm text-slate-600">
                            <i class="bi bi-currency-euro mr-1"></i>
                            <span th:text="${stats.valeurEntrees != null ? #numbers.formatCurrency(stats.valeurEntrees) : 'N/A'}">
                                N/A
                            </span>
                        </div>
                    </div>

                    <!-- Sorties -->
                    <div class="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <div class="text-xs font-bold text-slate-500 uppercase tracking-wider">Sorties</div>
                                <div class="text-3xl font-bold text-rose-600" 
                                     th:text="${stats.totalSorties}">980</div>
                            </div>
                            <i class="bi bi-box-arrow-up text-rose-200 text-3xl"></i>
                        </div>
                        <div class="text-sm text-slate-600">
                            <i class="bi bi-currency-euro mr-1"></i>
                            <span th:text="${stats.valeurSorties != null ? #numbers.formatCurrency(stats.valeurSorties) : 'N/A'}">
                                98.000 €
                            </span>
                        </div>
                    </div>

                    <!-- Solde Quantité -->
                    <div class="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <div class="text-xs font-bold text-slate-500 uppercase tracking-wider">Solde Quantité</div>
                                <div class="text-3xl font-bold text-blue-600" 
                                     th:text="${stats.soldeQuantite}">+270</div>
                            </div>
                            <i class="bi bi-arrow-left-right text-blue-200 text-3xl"></i>
                        </div>
                        <div th:class="${stats.soldeValeur != null && stats.soldeValeur >= 0} ? 'text-emerald-600' : 'text-rose-600'" 
                             class="text-sm font-bold">
                            <i th:if="${stats.soldeValeur >= 0}" class="bi bi-arrow-up mr-1"></i>
                            <i th:if="${stats.soldeValeur < 0}" class="bi bi-arrow-down mr-1"></i>
                            <span th:text="${stats.soldeValeur != null ? #numbers.formatCurrency(stats.soldeValeur) : 'N/A'}">
                                +27.000 €
                            </span>
                        </div>
                    </div>

                    <!-- Mouvements/Jour -->
                    <div class="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <div class="text-xs font-bold text-slate-500 uppercase tracking-wider">Mouvements/jour</div>
                                <div class="text-3xl font-bold text-amber-600" 
                                     th:text="${stats.moyenneJournaliere}">45</div>
                            </div>
                            <i class="bi bi-graph-up text-amber-200 text-3xl"></i>
                        </div>
                        <div class="text-sm text-slate-600">
                            Pic: <span th:text="${stats.picJournalier}" class="font-bold">78</span> mouvements
                        </div>
                    </div>
                </div>

                <!-- Graphiques -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Évolution Journalière -->
                    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm lg:col-span-2">
                        <div class="px-6 py-4 border-b border-slate-100">
                            <h5 class="text-lg font-bold text-slate-800 flex items-center">
                                <i class="bi bi-bar-chart mr-2"></i> Évolution Journalière
                            </h5>
                        </div>
                        <div class="p-6">
                            <canvas id="evolutionJournaliereChart" height="120"></canvas>
                        </div>
                    </div>

                    <!-- Répartition par Type -->
                    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm">
                        <div class="px-6 py-4 border-b border-slate-100">
                            <h5 class="text-lg font-bold text-slate-800 flex items-center">
                                <i class="bi bi-pie-chart mr-2"></i> Répartition par Type
                            </h5>
                        </div>
                        <div class="p-6">
                            <canvas id="repartitionTypeChart" height="200"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Tableau des mouvements -->
                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                    <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                        <h5 class="text-lg font-bold text-slate-800 flex items-center">
                            <i class="bi bi-table mr-2"></i> Derniers Mouvements
                            <span class="ml-2 bg-slate-800 text-white text-xs font-bold px-2 py-1 rounded-full" 
                                  th:text="${mouvements.size()}">50</span>
                        </h5>
                        <div class="flex space-x-2">
                            <button onclick="filtrerMouvements('all')" 
                                    class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg text-sm font-bold hover:bg-slate-200 transition-all">
                                Tous
                            </button>
                            <button onclick="filtrerMouvements('ENTREE')" 
                                    class="px-4 py-2 bg-emerald-100 text-emerald-700 rounded-lg text-sm font-bold hover:bg-emerald-200 transition-all">
                                Entrées
                            </button>
                            <button onclick="filtrerMouvements('SORTIE')" 
                                    class="px-4 py-2 bg-rose-100 text-rose-700 rounded-lg text-sm font-bold hover:bg-rose-200 transition-all">
                                Sorties
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-50 text-slate-500 font-bold uppercase text-[10px]">
                                <tr>
                                    <th class="px-6 py-4 text-left">Réf.</th>
                                    <th class="px-6 py-4 text-left">Type</th>
                                    <th class="px-6 py-4 text-left">Article</th>
                                    <th class="px-6 py-4 text-left">Quantité</th>
                                    <th class="px-6 py-4 text-left">Valeur</th>
                                    <th class="px-6 py-4 text-left">Dépôt</th>
                                    <th class="px-6 py-4 text-left">Date</th>
                                    <th class="px-6 py-4 text-left">Utilisateur</th>
                                </tr>
                            </thead>
                            <tbody id="mouvementsTable" class="divide-y divide-slate-100">
                                <tr th:each="mvt : ${mouvements}" 
                                    th:data-sens="${mvt.type != null ? mvt.type.sens : ''}"
                                    class="hover:bg-slate-50 transition-colors">
                                    <td class="px-6 py-4">
                                        <a th:href="@{'/stock/mouvements/details/' + ${mvt.id}}"
                                           class="font-mono text-blue-600 hover:text-blue-800 font-bold" 
                                           th:text="${mvt.reference}">MVT-2024-000123</a>
                                    </td>
                                    <td class="px-6 py-4">
                                        <span th:text="${mvt.type != null ? mvt.type.libelle : ''}" 
                                              class="font-medium">Réception</span>
                                        <div class="text-xs text-slate-500 mt-1">
                                              <span th:if="${mvt.bonReception != null}" 
                                                  th:text="${mvt.bonReception.bonCommande != null ? mvt.bonReception.bonCommande.referenceBc : ''}">BC-2024-001</span>
                                              <span th:if="${mvt.bonCommande != null}" 
                                                  th:text="${mvt.bonCommande.referenceBc}">BC-2024-001</span>
                                            <span th:if="${mvt.transfert != null}" 
                                                  th:text="${mvt.transfert.reference}">TRF-2024-001</span>
                                            <span th:if="${mvt.inventaire != null}" 
                                                  th:text="${mvt.inventaire.reference}">INV-2024-001</span>
                                            <span th:if="${mvt.bonReception == null and mvt.bonCommande == null and mvt.transfert == null and mvt.inventaire == null}">-</span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <a th:href="@{'/stock/articles/' + ${mvt.article.id}}"
                                           class="font-bold text-slate-800 hover:text-blue-600">
                                            <span th:text="${mvt.article.codeArticle}">ART-001</span>
                                        </a>
                                        <div class="text-xs text-slate-500 mt-1" 
                                             th:text="${mvt.article.libelle}">Laptop Pro</div>
                                        <div th:if="${mvt.lot != null}" 
                                             class="inline-block mt-1 bg-slate-100 text-slate-700 px-2 py-1 rounded text-[10px] font-mono">
                                            <i class="bi bi-tag mr-1"></i>
                                            <span th:text="${mvt.lot.numeroLot}">LOT-001</span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 font-bold" th:text="${mvt.quantite}">100</td>
                                    <td class="px-6 py-4 font-bold text-slate-800" 
                                        th:text="${mvt.valeurMouvement != null ? #numbers.formatCurrency(mvt.valeurMouvement) : '-'}">
                                        2.500 €
                                    </td>
                                    <td class="px-6 py-4" th:text="${mvt.depot != null ? mvt.depot.code : ''}">DEP-CENTRAL</td>
                                    <td class="px-6 py-4">
                                        <div class="text-sm text-slate-600" 
                                             th:text="${mvt.dateMouvement != null ? #temporals.format(mvt.dateMouvement, 'dd/MM HH:mm') : ''}">
                                            15/03 14:30
                                        </div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="text-xs font-mono text-slate-500" 
                                             th:text="${mvt.utilisateurId}">3333...3333</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script th:inline="javascript">
        // Initialiser les icônes
        lucide.createIcons();

        // Données pour les graphiques
        const evolutionData = {
            labels: [],
            datasets: [{
                label: 'Entrées',
                data: [],
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                fill: true
            }, {
                label: 'Sorties',
                data: [],
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                fill: true
            }]
        };

        const repartitionData = {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [
                    '#28a745', '#20c997', '#0dcaf0', '#6f42c1', 
                    '#fd7e14', '#dc3545', '#ffc107', '#6610f2'
                ],
                borderWidth: 0
            }]
        };

        window.onload = function() {
            // Initialiser les données de répartition
            const repartition = JSON.parse('[[${repartitionType}]]');
            repartitionData.labels = Object.keys(repartition);
            repartitionData.datasets[0].data = Object.values(repartition);

            // Graphique évolution journalière
            const ctx1 = document.getElementById('evolutionJournaliereChart').getContext('2d');
            new Chart(ctx1, {
                type: 'line',
                data: evolutionData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            },
                            title: {
                                display: true,
                                text: 'Nombre de mouvements'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        }
                    }
                }
            });

            // Graphique répartition
            const ctx2 = document.getElementById('repartitionTypeChart').getContext('2d');
            new Chart(ctx2, {
                type: 'doughnut',
                data: repartitionData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });

            // Charger les données journalières
            chargerDonneesJournalieres();
        };

        function chargerDonneesJournalieres() {
            fetch('/main/dashboard/api/mouvements/journalier?jours=' + [[${jours}]])
                .then(response => response.json())
                .then(data => {
                    evolutionData.labels = data.labels;
                    evolutionData.datasets[0].data = data.entrees;
                    evolutionData.datasets[1].data = data.sorties;
                    
                    // Mettre à jour le graphique
                    Chart.getChart('evolutionJournaliereChart').update();
                })
                .catch(error => console.error('Erreur chargement données:', error));
        }

        function filtrerMouvements(sens) {
            const rows = document.querySelectorAll('#mouvementsTable tr');
            rows.forEach(row => {
                if (sens === 'all' || row.dataset.sens === sens) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>