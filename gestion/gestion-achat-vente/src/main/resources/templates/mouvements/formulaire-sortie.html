<!-- templates/stock/mouvements/formulaire-sortie.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${title}">Sortie de Stock</title>
    
    <!-- Bootstrap 5 + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        .mouvement-card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .type-entree { border-left: 4px solid #28a745; }
        .type-sortie { border-left: 4px solid #dc3545; }
        .stock-disponible { color: #28a745; font-weight: bold; }
        .stock-insuffisant { color: #dc3545; font-weight: bold; }
        .lot-selectionne {
            background-color: #e7f1ff;
            border: 2px solid #0d6efd;
        }
        .auto-complete {
            max-height: 200px;
            overflow-y: auto;
            position: absolute;
            z-index: 1000;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav th:replace="~{fragments/navbar :: navbar(activePage=${activePage})}"></nav>
    
    <div class="container-fluid mt-4">
        <!-- En-tête -->
        <div class="row mb-4">
            <div class="col">
                <h1>
                    <i class="bi bi-box-arrow-up text-danger"></i> Sortie de Stock
                </h1>
                <p class="text-muted">Enregistrer une livraison client, consommation interne ou ajustement négatif</p>
            </div>
            <div class="col-auto">
                <a href="/stock/mouvements/journal" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Retour journal
                </a>
                <a href="/stock/mouvements/entree" class="btn btn-outline-success ms-2">
                    <i class="bi bi-box-arrow-in-down"></i> Entrée
                </a>
            </div>
        </div>
        
        <!-- Formulaire principal -->
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card mouvement-card type-sortie">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-dash-circle"></i> Nouvelle Sortie de Stock
                        </h5>
                    </div>
                    <div class="card-body">
                        <form method="post" action="/stock/mouvements/creer-sortie" id="formSortie">
                            
                            <!-- Type de mouvement -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Type de sortie *</label>
                                    <select class="form-select" name="typeMouvementId" required 
                                            id="typeSortie" onchange="changerTypeSortie()">
                                        <option value="">-- Sélectionner un type --</option>
                                        <option th:each="type : ${typesSortie}"
                                                th:value="${type.id}"
                                                th:text="${type.libelle}">
                                            Livraison client
                                        </option>
                                    </select>
                                    <small class="form-text text-muted">
                                        Définit la nature de la sortie
                                    </small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Date du mouvement *</label>
                                    <input type="date" class="form-control" name="dateMouvement" 
                                           th:value="${aujourdhui}" required>
                                </div>
                            </div>
                            
                            <hr>
                            
                            <!-- Source de la sortie -->
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" 
                                               name="sourceType" id="sourceArticle" 
                                               value="article" checked onclick="changerSource('article')">
                                        <label class="form-check-label" for="sourceArticle">
                                            Par article
                                        </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" 
                                               name="sourceType" id="sourceLot" 
                                               value="lot" onclick="changerSource('lot')">
                                        <label class="form-check-label" for="sourceLot">
                                            Par lot spécifique
                                        </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" 
                                               name="sourceType" id="sourceReservation" 
                                               value="reservation" onclick="changerSource('reservation')">
                                        <label class="form-check-label" for="sourceReservation">
                                            Depuis réservation
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Source : Article -->
                            <div id="sectionArticle" class="source-section">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Article *</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" 
                                                   id="rechercheArticleSortie" 
                                                   placeholder="Code, libellé ou code barre..."
                                                   autocomplete="off"
                                                   onkeyup="rechercherArticlesSortie(this.value)">
                                            <button class="btn btn-outline-secondary" type="button"
                                                    onclick="ouvrirSelectionArticleSortie()">
                                                <i class="bi bi-search"></i>
                                            </button>
                                        </div>
                                        <div id="resultatsArticlesSortie" class="auto-complete"></div>
                                        <input type="hidden" name="articleId" id="articleIdSortie">
                                        <div id="articleSelectionneSortie" class="mt-2 p-2 border rounded" 
                                             style="display: none;">
                                            <strong id="articleCodeSortie"></strong>
                                            <br>
                                            <small id="articleLibelleSortie"></small>
                                            <button type="button" class="btn btn-sm btn-outline-danger float-end"
                                                    onclick="effacerArticleSortie()">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Dépôt source *</label>
                                        <select class="form-select" name="depotId" id="depotSortie"
                                                onchange="verifierStockDisponible()" required>
                                            <option value="">-- Sélectionner un dépôt --</option>
                                            <option th:each="depot : ${depots}"
                                                    th:value="${depot.id}"
                                                    th:text="${depot.nom}">
                                                Entrepôt Central
                                            </option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Informations stock -->
                                <div class="row mb-3" id="infoStock" style="display: none;">
                                    <div class="col-md-12">
                                        <div class="alert" id="alertStock">
                                            <i class="bi bi-info-circle"></i>
                                            <span id="texteStock"></span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Lots disponibles (si article géré par lot) -->
                                <div id="sectionLotsDisponibles" style="display: none;">
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <label class="form-label">Sélectionner un lot (optionnel)</label>
                                            <div id="listeLots" class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                                                <!-- Liste des lots générée par JavaScript -->
                                            </div>
                                            <small class="form-text text-muted">
                                                Si aucun lot sélectionné, allocation automatique FIFO/FEFO
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Source : Lot spécifique -->
                            <div id="sectionLotSpecifique" class="source-section" style="display: none;">
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <label class="form-label">Numéro de lot *</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" 
                                                   id="rechercheLot" 
                                                   placeholder="Numéro de lot..."
                                                   autocomplete="off"
                                                   onkeyup="rechercherLots(this.value)">
                                            <button class="btn btn-outline-secondary" type="button"
                                                    onclick="ouvrirSelectionLot()">
                                                <i class="bi bi-search"></i>
                                            </button>
                                        </div>
                                        <div id="resultatsLots" class="auto-complete"></div>
                                        <input type="hidden" name="lotId" id="lotId">
                                        <div id="lotSelectionne" class="mt-2 p-2 border rounded" 
                                             style="display: none;">
                                            <div class="row">
                                                <div class="col">
                                                    <strong id="lotNumero"></strong>
                                                    <br>
                                                    <small>
                                                        Article: <span id="lotArticle"></span>
                                                        | Quantité: <span id="lotQuantite"></span>
                                                        | Péremption: <span id="lotPeremption"></span>
                                                    </small>
                                                </div>
                                                <div class="col-auto">
                                                    <button type="button" class="btn btn-sm btn-outline-danger"
                                                            onclick="effacerLot()">
                                                        <i class="bi bi-x"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Source : Réservation -->
                            <div id="sectionReservation" class="source-section" style="display: none;">
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <label class="form-label">Référence réservation *</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" 
                                                   id="rechercheReservation" 
                                                   placeholder="Référence réservation..."
                                                   autocomplete="off"
                                                   onkeyup="rechercherReservations(this.value)">
                                            <button class="btn btn-outline-secondary" type="button"
                                                    onclick="ouvrirSelectionReservation()">
                                                <i class="bi bi-search"></i>
                                            </button>
                                        </div>
                                        <div id="resultatsReservations" class="auto-complete"></div>
                                        <input type="hidden" name="reservationId" id="reservationId">
                                        <div id="reservationSelectionnee" class="mt-2 p-2 border rounded" 
                                             style="display: none;">
                                            <div class="row">
                                                <div class="col">
                                                    <strong id="reservationReference"></strong>
                                                    <br>
                                                    <small>
                                                        Article: <span id="reservationArticle"></span>
                                                        | Quantité: <span id="reservationQuantite"></span>
                                                        | Commande: <span id="reservationCommande"></span>
                                                    </small>
                                                </div>
                                                <div class="col-auto">
                                                    <button type="button" class="btn btn-sm btn-outline-danger"
                                                            onclick="effacerReservation()">
                                                        <i class="bi bi-x"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Quantité -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Quantité *</label>
                                    <input type="number" class="form-control" name="quantite" 
                                           id="quantiteSortie"
                                           min="1" required step="1" value="1"
                                           onchange="verifierQuantite()">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Document référence</label>
                                    <input type="text" class="form-control" name="documentRef"
                                           placeholder="Ex: BL-2024-001, Commande CMD-123...">
                                </div>
                            </div>
                            
                            <!-- Destinataire (pour livraison client) -->
                            <div id="sectionDestinataire" style="display: none;">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Client / Destinataire</label>
                                        <input type="text" class="form-control" name="destinataire"
                                               placeholder="Nom du client...">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Commande client</label>
                                        <input type="text" class="form-control" name="commandeClientRef"
                                               placeholder="Référence commande...">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Motif et observations -->
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <label class="form-label">Motif / Observations *</label>
                                    <textarea class="form-control" name="motif" rows="3"
                                              placeholder="Raison de la sortie..." required></textarea>
                                </div>
                            </div>
                            
                            <!-- Validation -->
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" 
                                               id="validationDouble" name="validationDouble">
                                        <label class="form-check-label" for="validationDouble">
                                            <i class="bi bi-shield-check"></i>
                                            Requiert validation double (pour sorties importantes)
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Boutons -->
                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-outline-secondary w-100"
                                            onclick="previsualiserSortie()">
                                        <i class="bi bi-eye"></i> Prévisualiser
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button type="submit" class="btn btn-danger w-100" id="btnSubmit">
                                        <i class="bi bi-check-circle"></i> Enregistrer la sortie
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Résumé prévisualisation -->
                <div class="card mt-4" id="previsualisationSortie" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-eye"></i> Prévisualisation
                        </h5>
                    </div>
                    <div class="card-body" id="previewContentSortie">
                        <!-- Contenu généré par JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals de sélection -->
    <div th:replace="~{stock/mouvements/modals :: modals}"></div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales
        let stockDisponible = 0;
        let articleGestionLot = false;
        let articleId = '';
        let depotId = '';
        let lotSelectionneId = '';
        
        // Changer source (article/lot/réservation)
        function changerSource(source) {
            // Masquer toutes les sections
            document.querySelectorAll('.source-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Afficher la section sélectionnée
            document.getElementById('section' + source.charAt(0).toUpperCase() + source.slice(1)).style.display = 'block';
            
            // Réinitialiser les champs cachés
            if (source !== 'article') {
                document.getElementById('articleIdSortie').value = '';
            }
            if (source !== 'lot') {
                document.getElementById('lotId').value = '';
            }
            if (source !== 'reservation') {
                document.getElementById('reservationId').value = '';
            }
        }
        
        // Changer type de sortie
        function changerTypeSortie() {
            const type = document.getElementById('typeSortie').value;
            const sectionDestinataire = document.getElementById('sectionDestinataire');
            
            // Afficher section destinataire seulement pour livraison client
            if (type === 'type_livraison_client') { // À adapter selon vos IDs
                sectionDestinataire.style.display = 'block';
            } else {
                sectionDestinataire.style.display = 'none';
            }
        }
        
        // Gestion articles
        function ouvrirSelectionArticleSortie() {
            // Implémenter l'ouverture de modal (similaire à formulaire entrée)
            alert('Modal de sélection article');
        }
        
        function rechercherArticlesSortie(terme) {
            // Simuler recherche AJAX
            if (terme.length < 2) return;
            
            // Code similaire à formulaire entrée
        }
        
        function selectionnerArticleSortie(id, code, libelle, gestionParLot) {
            articleId = id;
            articleGestionLot = gestionParLot;
            
            document.getElementById('articleIdSortie').value = id;
            document.getElementById('articleCodeSortie').textContent = code;
            document.getElementById('articleLibelleSortie').textContent = libelle;
            document.getElementById('articleSelectionneSortie').style.display = 'block';
            
            // Vérifier le stock si dépôt déjà sélectionné
            if (depotId) {
                verifierStockDisponible();
            }
            
            // Charger les lots si article géré par lot
            if (gestionParLot && depotId) {
                chargerLotsDisponibles();
            }
        }
        
        function effacerArticleSortie() {
            articleId = '';
            articleGestionLot = false;
            document.getElementById('articleIdSortie').value = '';
            document.getElementById('articleSelectionneSortie').style.display = 'none';
            document.getElementById('infoStock').style.display = 'none';
            document.getElementById('sectionLotsDisponibles').style.display = 'none';
        }
        
        // Vérifier stock disponible
        function verifierStockDisponible() {
            depotId = document.getElementById('depotSortie').value;
            
            if (!articleId || !depotId) {
                return;
            }
            
            // Simuler appel API
            fetch(`/api/stock/disponible?articleId=${articleId}&depotId=${depotId}`)
                .then(response => response.json())
                .then(data => {
                    stockDisponible = data.quantiteDisponible || 0;
                    const quantiteDemandee = parseInt(document.getElementById('quantiteSortie').value) || 1;
                    
                    const infoStock = document.getElementById('infoStock');
                    const alertStock = document.getElementById('alertStock');
                    const texteStock = document.getElementById('texteStock');
                    
                    infoStock.style.display = 'block';
                    
                    if (stockDisponible >= quantiteDemandee) {
                        alertStock.className = 'alert alert-success';
                        texteStock.innerHTML = `
                            <i class="bi bi-check-circle"></i>
                            Stock disponible: <span class="stock-disponible">${stockDisponible}</span> unités
                            <br>
                            <small>La sortie peut être effectuée</small>
                        `;
                        document.getElementById('btnSubmit').disabled = false;
                    } else {
                        alertStock.className = 'alert alert-danger';
                        texteStock.innerHTML = `
                            <i class="bi bi-exclamation-triangle"></i>
                            Stock insuffisant! Disponible: <span class="stock-insuffisant">${stockDisponible}</span> unités
                            <br>
                            <small>Quantité demandée: ${quantiteDemandee}</small>
                        `;
                        document.getElementById('btnSubmit').disabled = true;
                    }
                    
                    // Afficher section lots si article géré par lot
                    if (articleGestionLot && stockDisponible > 0) {
                        document.getElementById('sectionLotsDisponibles').style.display = 'block';
                        chargerLotsDisponibles();
                    }
                });
        }
        
        // Charger lots disponibles
        function chargerLotsDisponibles() {
            if (!articleId || !depotId) return;
            
            // Simuler appel API
            fetch(`/api/lots/disponibles?articleId=${articleId}&depotId=${depotId}`)
                .then(response => response.json())
                .then(lots => {
                    const container = document.getElementById('listeLots');
                    let html = '';
                    
                    if (lots.length === 0) {
                        html = '<div class="text-center text-muted p-3">Aucun lot disponible</div>';
                    } else {
                        lots.forEach(lot => {
                            const estSelectionne = lot.id === lotSelectionneId;
                            html += `
                                <div class="p-2 mb-1 border rounded ${estSelectionne ? 'lot-selectionne' : ''}" 
                                     style="cursor: pointer;"
                                     onclick="selectionnerLot('${lot.id}', '${lot.numero}', ${lot.quantite}, '${lot.datePeremption}')">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <strong>${lot.numero}</strong>
                                            <br>
                                            <small>
                                                Quantité: ${lot.quantite} | 
                                                Péremption: ${lot.datePeremption || 'N/A'}
                                            </small>
                                        </div>
                                        ${estSelectionne ? '<i class="bi bi-check-circle text-success"></i>' : ''}
                                    </div>
                                </div>
                            `;
                        });
                    }
                    
                    container.innerHTML = html;
                });
        }
        
        // Sélectionner un lot
        function selectionnerLot(id, numero, quantite, peremption) {
            lotSelectionneId = id;
            document.querySelector('input[name="lotId"]').value = id;
            
            // Mettre en évidence visuellement
            document.querySelectorAll('#listeLots > div').forEach(div => {
                div.classList.remove('lot-selectionne');
            });
            event.currentTarget.classList.add('lot-selectionne');
            
            // Mettre à jour la quantité max
            const inputQuantite = document.getElementById('quantiteSortie');
            inputQuantite.max = quantite;
            
            if (parseInt(inputQuantite.value) > quantite) {
                inputQuantite.value = quantite;
                verifierQuantite();
            }
            
            // Recharger la liste pour afficher la sélection
            chargerLotsDisponibles();
        }
        
        // Vérifier quantité
        function verifierQuantite() {
            const quantite = parseInt(document.getElementById('quantiteSortie').value) || 0;
            
            if (lotSelectionneId) {
                // Si lot spécifique sélectionné, vérifier quantité du lot
                const lotDiv = document.querySelector('.lot-selectionne');
                if (lotDiv) {
                    const lotQuantite = parseInt(lotDiv.querySelector('small').textContent.match(/Quantité: (\d+)/)[1]);
                    if (quantite > lotQuantite) {
                        alert(`Quantité maximale pour ce lot: ${lotQuantite}`);
                        document.getElementById('quantiteSortie').value = lotQuantite;
                    }
                }
            } else if (stockDisponible > 0 && quantite > stockDisponible) {
                alert(`Stock disponible insuffisant. Maximum: ${stockDisponible}`);
                document.getElementById('quantiteSortie').value = stockDisponible;
            }
        }
        
        // Prévisualisation
        function previsualiserSortie() {
            const form = document.getElementById('formSortie');
            const formData = new FormData(form);
            
            let sourceText = '';
            if (document.getElementById('sourceArticle').checked) {
                sourceText = `Article: ${document.getElementById('articleCodeSortie').textContent}`;
            } else if (document.getElementById('sourceLot').checked) {
                sourceText = `Lot: ${document.getElementById('lotNumero').textContent}`;
            } else if (document.getElementById('sourceReservation').checked) {
                sourceText = `Réservation: ${document.getElementById('reservationReference').textContent}`;
            }
            
            let preview = `
                <h6>Résumé de la sortie</h6>
                <table class="table table-sm">
                    <tr>
                        <td><strong>Type:</strong></td>
                        <td>${document.querySelector('select[name="typeMouvementId"] option:checked').textContent}</td>
                    </tr>
                    <tr>
                        <td><strong>Source:</strong></td>
                        <td>${sourceText}</td>
                    </tr>
                    <tr>
                        <td><strong>Quantité:</strong></td>
                        <td>${formData.get('quantite')} unités</td>
                    </tr>
                    <tr>
                        <td><strong>Stock disponible:</strong></td>
                        <td>${stockDisponible} unités</td>
                    </tr>
                    <tr>
                        <td><strong>Date:</strong></td>
                        <td>${formData.get('dateMouvement')}</td>
                    </tr>
                    <tr>
                        <td><strong>Motif:</strong></td>
                        <td>${formData.get('motif')}</td>
                    </tr>
                </table>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    Cette sortie réduira immédiatement le stock disponible.
                </div>
            `;
            
            document.getElementById('previewContentSortie').innerHTML = preview;
            document.getElementById('previsualisationSortie').style.display = 'block';
        }
        
        // Validation avant soumission
        document.getElementById('formSortie').addEventListener('submit', function(e) {
            // Vérifier source sélectionnée
            let sourceValide = false;
            if (document.getElementById('sourceArticle').checked && document.getElementById('articleIdSortie').value) {
                sourceValide = true;
            } else if (document.getElementById('sourceLot').checked && document.getElementById('lotId').value) {
                sourceValide = true;
            } else if (document.getElementById('sourceReservation').checked && document.getElementById('reservationId').value) {
                sourceValide = true;
            }
            
            if (!sourceValide) {
                e.preventDefault();
                alert('Veuillez sélectionner une source valide (article, lot ou réservation)');
                return;
            }
            
            // Vérifier stock disponible
            const quantite = parseInt(document.getElementById('quantiteSortie').value) || 0;
            if (stockDisponible < quantite && !document.getElementById('sourceReservation').checked) {
                e.preventDefault();
                alert('Stock insuffisant pour effectuer cette sortie');
                return;
            }
            
            if (!confirm('Confirmer la création de cette sortie de stock ?')) {
                e.preventDefault();
            }
        });
        
        // Initialiser
        document.addEventListener('DOMContentLoaded', function() {
            // Initialiser avec source article par défaut
            changerSource('article');
        });
    </script>
</body>
</html>