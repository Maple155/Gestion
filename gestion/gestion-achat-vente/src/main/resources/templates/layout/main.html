<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:fragment="layout(content)">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Achats - ERP</title>
    
    <link rel="stylesheet" th:href="@{/css/style.css}">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="antialiased">

    <header class="top-header px-8 py-4 flex justify-between items-center sticky top-0 z-10">
        <div class="flex items-center space-x-2">
            <i data-lucide="home" class="w-4 h-4 text-slate-400"></i>
            <span class="text-[10px] font-black uppercase tracking-widest text-slate-400">
                ERP System &bull; 
                <span th:text="${activePage == 'stock-inventaires' ? 'Inventaires' : 'Achats'}"></span>
            </span>
        </div>
        <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2 text-sm">
                <i data-lucide="user" class="w-4 h-4 text-slate-500"></i>
                <span th:text="${session.userFullName}" class="font-medium text-slate-700"></span>
                <span th:text="'(' + ${session.userRole} + ')'" class="text-xs text-slate-500"></span>
            </div>
            <div class="h-4 w-[1px] bg-slate-200"></div>
            <a href="/logout" class="text-xs font-bold text-rose-500 hover:text-rose-600 flex items-center">
                DÉCONNEXION <i data-lucide="log-out" class="ml-2 w-3 h-3"></i>
            </a>
        </div>
    </header>
    
    <div class="flex h-screen overflow-hidden">
        
        <aside class="w-64 sidebar text-white flex-shrink-0 flex flex-col shadow-2xl">
            <div class="sidebar-logo flex items-center space-x-3">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-500/20">
                    <i data-lucide="layers" class="text-white w-5 h-5"></i>
                </div>
                <span class="text-white font-bold tracking-tight text-lg">CORE <span class="text-blue-500">ERP</span></span>
            </div>
            
            <nav class="mt-4 flex-1 overflow-y-auto px-2">
                <p class="nav-group-label">Menu Principal</p>
                
                <div class="mb-1">
                    <button onclick="toggleDropdown('achat-menu', 'achat-arrow')" class="nav-link-main w-full group">
                        <div class="flex items-center">
                            <i data-lucide="shopping-bag" class="mr-3 w-5 h-5 group-hover:text-blue-400"></i>
                            <span class="font-medium text-sm">Gestion Achats</span>
                        </div>
                        <i data-lucide="chevron-down" id="achat-arrow" class="w-4 h-4 opacity-50 transition-transform duration-300"></i>
                    </button>
                    
                    <div id="achat-menu" class="dropdown-container">
                        <a th:href="@{/achats/demandes}" class="nav-link-sub">
                            <i data-lucide="file-text" class="w-3 h-3 mr-2 opacity-50"></i> Demandes
                        </a>
                        <a th:href="@{/achats/bons-commande/liste}" class="nav-link-sub">
                            <i data-lucide="send" class="w-3 h-3 mr-2 opacity-50"></i> BC Envoyés
                        </a>

                        <div>
                            <button onclick="toggleDropdown('br-menu', 'br-arrow')" class="nav-link-sub w-full justify-between pr-4 group">
                                <span class="flex items-center">
                                    <i data-lucide="truck" class="w-3 h-3 mr-2 opacity-50"></i> Réceptions
                                </span>
                                <i data-lucide="chevron-down" id="br-arrow" class="w-3 h-3 opacity-50 transition-transform"></i>
                            </button>
                            <div id="br-menu" class="dropdown-container inner-menu">
                                <a th:href="@{/achats/reception/liste}" class="nav-link-sub !pl-4 py-1.5 text-xs">Liste des BR</a>
                                <a th:href="@{/achats/reception/nouveau}" class="nav-link-sub !pl-4 py-1.5 text-xs">Nouveau BR</a>
                            </div>
                        </div>

                        <a th:href="@{/achats/factures/liste}" class="nav-link-sub">
                            <i data-lucide="credit-card" class="w-3 h-3 mr-2 opacity-50"></i> Factures
                        </a>
                        <a th:href="@{/achats/fournisseurs}" class="nav-link-sub">
                            <i data-lucide="users" class="w-3 h-3 mr-2 opacity-50"></i> Fournisseurs
                        </a>
                                                <a th:href="@{/achats/dashboard}" class="nav-link-sub">
                            <i data-lucide="file-text" class="w-3 h-3 mr-2 opacity-50"></i> Dashboard
                        </a>
                    </div>
                </div>

                <div class="mb-1">
                    <button onclick="toggleDropdown('vente-menu', 'vente-arrow')" class="nav-link-main w-full group">
                        <div class="flex items-center">
                            <i data-lucide="shopping-cart" class="mr-3 w-5 h-5 group-hover:text-indigo-400"></i>
                            <span class="font-medium text-sm">Gestion Ventes</span>
                        </div>
                        <i data-lucide="chevron-down" id="vente-arrow" class="w-4 h-4 opacity-50 transition-transform duration-300"></i>
                    </button>
                    
                    <div id="vente-menu" class="dropdown-container">
                        <a th:href="@{/ventes/devis/liste}" class="nav-link-sub">
                            <i data-lucide="file-text" class="w-3 h-3 mr-2 opacity-50"></i> Devis
                        </a>
                        <a th:href="@{/ventes/commandes/liste}" class="nav-link-sub">
                            <i data-lucide="clipboard-list" class="w-3 h-3 mr-2 opacity-50"></i> Commandes
                        </a>
                        <a th:href="@{/ventes/livraisons/liste}" class="nav-link-sub">
                            <i data-lucide="truck" class="w-3 h-3 mr-2 opacity-50"></i> Livraisons
                        </a>
                        <a th:href="@{/ventes/factures/liste}" class="nav-link-sub">
                            <i data-lucide="credit-card" class="w-3 h-3 mr-2 opacity-50"></i> Factures
                        </a>
                        <a th:href="@{/ventes/paiements/liste}" class="nav-link-sub">
                            <i data-lucide="wallet" class="w-3 h-3 mr-2 opacity-50"></i> Paiements
                        </a>
                        <a th:href="@{/ventes/avoirs/liste}" class="nav-link-sub">
                            <i data-lucide="rotate-ccw" class="w-3 h-3 mr-2 opacity-50"></i> Avoirs
                        </a>
                        <a th:href="@{/ventes/clients}" class="nav-link-sub">
                            <i data-lucide="users" class="w-3 h-3 mr-2 opacity-50"></i> Clients
                        </a>
                        <a th:if="${session.userRole == 'ADMIN' or session.userRole == 'RESPONSABLE_VENTES'}"
                           th:href="@{/ventes/kpi/responsable}" class="nav-link-sub">
                            <i data-lucide="bar-chart-3" class="w-3 h-3 mr-2 opacity-50"></i> KPI Responsable
                        </a>
                    </div>
                </div>
            </nav>

            <div class="p-4 border-t border-slate-800/50 bg-black/10">
                <div class="flex items-center p-2">
                    <div class="w-8 h-8 rounded bg-slate-700 flex items-center justify-center text-[10px] font-bold">AD</div>
                    <div class="ml-3">
                        <p class="text-[11px] font-bold text-white leading-none">Administrateur</p>
                        <p class="text-[10px] text-slate-500 mt-1">Connecté</p>
                    </div>
                </div>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto flex flex-col">
            <!-- <header class="top-header px-8 py-4 flex justify-between items-center sticky top-0 z-10">
                <div class="flex items-center space-x-2">
                    <i data-lucide="home" class="w-4 h-4 text-slate-400"></i>
                    <span class="text-[10px] font-black uppercase tracking-widest text-slate-400">ERP System &bull; Achats</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button class="text-slate-500 hover:text-blue-600 transition-colors">
                        <i data-lucide="bell" class="w-5 h-5"></i>
                    </button>
                    <div class="h-4 w-[1px] bg-slate-200"></div>
                    <a href="/logout" class="text-xs font-bold text-rose-500 hover:text-rose-600 flex items-center">
                        DÉCONNEXION <i data-lucide="log-out" class="ml-2 w-3 h-3"></i>
                    </a>
                </div>
            </header>
             -->
            <div class="p-8 max-w-7xl mx-auto w-full">
                <div th:replace="${content}"></div>
            </div>
        </main>
    </div>

    <script th:inline="javascript">
        lucide.createIcons();

        function toggleDropdown(menuId, arrowId) {
            const menu = document.getElementById(menuId);
            const arrow = document.getElementById(arrowId);

            if (!menu.classList.contains('dropdown-open')) {
                const openMenus = document.querySelectorAll('.dropdown-open');
                openMenus.forEach(m => {
                    // On ne ferme pas si c'est un parent du menu qu'on ouvre
                    if (!m.contains(menu)) m.classList.remove('dropdown-open');
                });
            }

            menu.classList.toggle('dropdown-open');
            if(arrow) arrow.classList.toggle('rotate-icon');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const path = window.location.pathname;
            // Ouverture auto basée sur l'URL
            if (path.includes('/achats')) {
                const menu = document.getElementById('achat-menu');
                if(menu) menu.classList.add('dropdown-open');
                const arrow = document.getElementById('achat-arrow');
                if(arrow) arrow.classList.add('rotate-icon');
            }
            if (path.includes('/ventes')) {
                const menu = document.getElementById('vente-menu');
                if(menu) menu.classList.add('dropdown-open');
                const arrow = document.getElementById('vente-arrow');
                if(arrow) arrow.classList.add('rotate-icon');
            }
            if (path.includes('/reception')) {
                const brMenu = document.getElementById('br-menu');
                if(brMenu) brMenu.classList.add('dropdown-open');
                const brArrow = document.getElementById('br-arrow');
                if(brArrow) brArrow.classList.add('rotate-icon');
            }
        });
    </script>
</body>
</html>